<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Custom scrollbar */
        .overflow-y-auto::-webkit-scrollbar {
            width: 6px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: transparent;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* KPI Card animations */
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }
        @keyframes pulse-yellow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        .kpi-green { animation: pulse-green 2s infinite; }
        .kpi-yellow { animation: pulse-yellow 2s infinite; }
        .kpi-red { animation: pulse-red 2s infinite; }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Heatmap styles */
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 1px;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 8px;
            height: 300px;
        }

        .heatmap-cell {
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 500;
            color: white;
            transition: opacity 0.2s;
        }

        .heatmap-cell:hover {
            opacity: 0.8;
        }

        /* Latency labels */
        .latency-labels {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 300px;
            padding: 8px 0;
        }

        .latency-label {
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            text-align: right;
            padding-right: 8px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-xl border-b border-slate-200/50 px-6 py-4 shadow-sm">
        <div class="flex justify-between items-center max-w-7xl mx-auto">
            <div class="flex items-center space-x-4">
                <a href="index.html" class="flex items-center space-x-2 text-slate-600 hover:text-slate-800 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    <span class="font-medium">Back to Chat</span>
                </a>
                <div class="w-px h-6 bg-slate-300"></div>
                <h1 class="text-xl font-bold gradient-text">System Dashboard</h1>
            </div>

            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 text-sm text-slate-500">
                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span id="data-source">Live Data</span>
                </div>
                <div class="text-sm text-slate-500">
                    Last updated: <span id="lastUpdated">Just now</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto px-6 py-8 space-y-8">

        <!-- Row 1: System Health at a Glance -->
        <section>
            <h2 class="text-2xl font-bold text-slate-800 mb-6">System Health at a Glance</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <!-- Request Rate -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200 kpi-green" data-kpi="request-rate">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-emerald-100 rounded-lg">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>
                        </div>
                        <div class="flex items-center space-x-1 kpi-trend">
                            <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                            </svg>
                            <span class="text-xs font-medium text-emerald-600">+5%</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-slate-500">Request Rate</p>
                        <p class="text-3xl font-bold text-slate-800 kpi-value">1,250 <span class="text-sm font-normal text-slate-500">req/s</span></p>
                        <p class="text-xs text-slate-400">↑ 5% from last hour</p>
                    </div>
                </div>

                <!-- Error Rate -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200 kpi-green" data-kpi="error-rate">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-emerald-100 rounded-lg">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                            </svg>
                        </div>
                        <div class="flex items-center space-x-1 kpi-trend">
                            <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
                            </svg>
                            <span class="text-xs font-medium text-emerald-600">-0.2%</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-slate-500">Error Rate</p>
                        <p class="text-3xl font-bold text-slate-800 kpi-value">0.8 <span class="text-sm font-normal text-slate-500">%</span></p>
                        <p class="text-xs text-slate-400">↓ 0.2% from last hour</p>
                    </div>
                </div>

                <!-- P95 Latency -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200 kpi-yellow" data-kpi="latency">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-amber-100 rounded-lg">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex items-center space-x-1 kpi-trend">
                            <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                            </svg>
                            <span class="text-xs font-medium text-amber-600">+15ms</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-slate-500">P95 Latency</p>
                        <p class="text-3xl font-bold text-slate-800 kpi-value">245 <span class="text-sm font-normal text-slate-500">ms</span></p>
                        <p class="text-xs text-slate-400">↑ 15ms from last hour</p>
                    </div>
                </div>

                <!-- CPU Usage -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200 kpi-green" data-kpi="cpu">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-emerald-100 rounded-lg">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">Stable</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-slate-500">CPU Usage</p>
                        <p class="text-3xl font-bold text-slate-800 kpi-value">45 <span class="text-sm font-normal text-slate-500">%</span></p>
                        <p class="text-xs text-slate-400">Stable utilization</p>
                    </div>
                </div>

                <!-- Memory Usage -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200 kpi-green" data-kpi="memory">
                    <div class="flex items-center justify-between mb-4">
                        <div class="p-3 bg-emerald-100 rounded-lg">
                            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                            </svg>
                        </div>
                        <span class="text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">70%</span>
                    </div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium text-slate-500">Memory Usage</p>
                        <p class="text-3xl font-bold text-slate-800 kpi-value">2.8 <span class="text-sm font-normal text-slate-500">GB / 4 GB</span></p>
                        <p class="text-xs text-slate-400">70% utilization</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Row 2: Core Performance Graphs -->
        <section>
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Core Performance Graphs</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- Request Rate & Error Rate Chart -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Request Rate & Error Rate</h3>
                    <div class="chart-container">
                        <canvas id="requestErrorChart"></canvas>
                    </div>
                    <div class="mt-4 flex items-center justify-center space-x-6 text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-slate-600">Request Rate (req/s)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-slate-600">Error Rate (%)</span>
                        </div>
                    </div>
                </div>

                <!-- Response Latency Heatmap -->
                <div class="bg-white rounded-xl p-6 shadow-lg border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-800 mb-4">Response Latency Distribution</h3>
                    <div class="chart-container">
                        <canvas id="latencyHeatmap"></canvas>
                    </div>
                    <div class="mt-4 flex items-center justify-center space-x-6 text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-slate-600">Fast (< 500ms)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                            <span class="text-slate-600">Medium (500-1000ms)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-slate-600">Slow (> 1000ms)</span>
                        </div>
                    </div>
                </div>

            </div>
        </section>

    </main>

    <script>
        // SignalR connection for real-time updates
        let telemetryHubConnection;

        // Initialize SignalR connection
        async function initializeSignalR() {
            try {
                telemetryHubConnection = new signalR.HubConnectionBuilder()
                    .withUrl('/telemetryhub')
                    .withAutomaticReconnect()
                    .build();

                telemetryHubConnection.on('ReceiveMetrics', function (metrics) {
                    updateDashboardWithMetrics(metrics);
                });

                await telemetryHubConnection.start();
                console.log('SignalR connected for real-time telemetry updates');
            } catch (err) {
                console.error('SignalR connection failed:', err);
                // Fallback to polling if SignalR fails
                setInterval(fetchMetrics, 5000);
            }
        }

        // Fetch metrics from API
        async function fetchMetrics() {
            try {
                const response = await fetch('/api/telemetry/health');
                if (response.ok) {
                    const metrics = await response.json();
                    updateDashboardWithMetrics(metrics);
                } else {
                    console.error('Failed to fetch metrics:', response.status);
                }
            } catch (error) {
                console.error('Error fetching metrics:', error);
            }
        }

        // Update dashboard with real metrics data
        function updateDashboardWithMetrics(metrics) {
            if (!metrics) return;

            // Update KPI cards
            updateKpiCard('request-rate', metrics.requestRate);
            updateKpiCard('error-rate', metrics.errorRate);
            updateKpiCard('latency', metrics.latency);
            updateKpiCard('cpu', metrics.cpuUsage);
            updateKpiCard('memory', metrics.memoryUsage);

            // Update timestamp
            updateTimestamp();

            // Update data source indicator
            updateDataSource(metrics.source);
        }

        // Update individual KPI card
        function updateKpiCard(cardId, metricData) {
            if (!metricData) return;

            const card = document.querySelector(`[data-kpi="${cardId}"]`);
            if (!card) return;

            // Update value
            const valueElement = card.querySelector('.kpi-value');
            if (valueElement) {
                let displayValue = metricData.value;
                let unit = '';

                switch (cardId) {
                    case 'request-rate':
                        unit = ' req/s';
                        displayValue = displayValue.toFixed(1);
                        break;
                    case 'error-rate':
                        unit = '%';
                        displayValue = displayValue.toFixed(2);
                        break;
                    case 'latency':
                        unit = ' ms';
                        displayValue = Math.round(displayValue);
                        break;
                    case 'cpu':
                        unit = '%';
                        displayValue = displayValue.toFixed(1);
                        break;
                    case 'memory':
                        unit = ` GB / ${metricData.total || 4} GB`;
                        displayValue = displayValue.toFixed(1);
                        break;
                }

                valueElement.textContent = displayValue + unit;
            }

            // Update trend indicator
            const trendElement = card.querySelector('.kpi-trend');
            if (trendElement) {
                trendElement.textContent = `↑ ${metricData.change || 0}`;
                trendElement.className = `kpi-trend ${getTrendClass(metricData.trend)}`;
            }

            // Update card styling based on status
            updateCardStatus(card, cardId, metricData);
        }

        // Get CSS class for trend
        function getTrendClass(trend) {
            switch (trend) {
                case 'up': return 'text-red-600';
                case 'down': return 'text-green-600';
                default: return 'text-gray-600';
            }
        }

        // Update card status (color coding)
        function updateCardStatus(card, cardId, metricData) {
            // Remove existing status classes
            card.classList.remove('kpi-green', 'kpi-yellow', 'kpi-red');

            // Determine status based on metric values
            let statusClass = 'kpi-green'; // Default to green

            switch (cardId) {
                case 'error-rate':
                    if (metricData.value > 5) statusClass = 'kpi-red';
                    else if (metricData.value > 1) statusClass = 'kpi-yellow';
                    break;
                case 'latency':
                    if (metricData.value > 1000) statusClass = 'kpi-red';
                    else if (metricData.value > 500) statusClass = 'kpi-yellow';
                    break;
                case 'cpu':
                    if (metricData.value > 90) statusClass = 'kpi-red';
                    else if (metricData.value > 70) statusClass = 'kpi-yellow';
                    break;
                case 'memory':
                    if (metricData.percentage > 90) statusClass = 'kpi-red';
                    else if (metricData.percentage > 80) statusClass = 'kpi-yellow';
                    break;
            }

            card.classList.add(statusClass);
        }

        // Update data source indicator
        function updateDataSource(source) {
            const indicator = document.getElementById('data-source');
            if (indicator) {
                const sourceText = source === 'azure-monitor' ? 'Azure Monitor' : 'Application Metrics';
                indicator.textContent = `Live Data (${sourceText})`;
            }
        }

        // Update timestamp
        function updateTimestamp() {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('lastUpdated').textContent = timestamp;
        }

        // Fetch historical data for charts
        async function fetchHistoricalData() {
            try {
                // For now, generate realistic historical data based on current metrics
                // In a full implementation, this would fetch from a time-series API
                const response = await fetch('/api/telemetry/metrics?timeRange=PT24H');
                if (response.ok) {
                    const data = await response.json();
                    updateChartsWithHistoricalData(data);
                }
            } catch (error) {
                console.error('Error fetching historical data:', error);
                // Generate fallback historical data
                generateFallbackHistoricalData();
            }
        }

        // Update charts with historical data
        function updateChartsWithHistoricalData(data) {
            if (!data || !data.dataPoints) {
                generateFallbackHistoricalData();
                return;
            }

            // Update request/error rate chart
            updateRequestErrorChart(data.dataPoints);

            // Update latency heatmap
            updateLatencyHeatmap(data.dataPoints);
        }

        // Generate fallback historical data when API is not available
        function generateFallbackHistoricalData() {
            const now = new Date();
            const hours = Array.from({length: 24}, (_, i) => {
                const date = new Date(now);
                date.setHours(now.getHours() - (23 - i));
                return date;
            });

            // Generate realistic data based on current metrics
            const baseRequestRate = 25;
            const baseErrorRate = 0.8;
            const baseLatency = 245;

            const requestData = hours.map((_, i) => baseRequestRate + Math.sin(i / 3) * 10 + Math.random() * 5);
            const errorData = hours.map((_, i) => Math.max(0, baseErrorRate + Math.sin(i / 4) * 0.3 + Math.random() * 0.2));

            // Create data points for charts
            const dataPoints = hours.map((timestamp, i) => ({
                timestamp: timestamp.toISOString(),
                requestRate: { value: requestData[i] },
                errorRate: { value: errorData[i] },
                latency: { value: baseLatency + Math.sin(i / 4) * 50 + Math.random() * 20 }
            }));

            // Update request/error chart
            updateRequestErrorChart(dataPoints);

            // Update latency heatmap with realistic data
            updateLatencyHeatmap(dataPoints);
        }

        // Update request/error rate chart with real data
        function updateRequestErrorChart(dataPoints) {
            const labels = dataPoints.map((point, index) => {
                const date = new Date(point.timestamp);
                return date.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            });

            const requestData = dataPoints.map(point => point.requestRate.value);
            const errorData = dataPoints.map(point => point.errorRate.value);

            requestErrorChart.data.labels = labels;
            requestErrorChart.data.datasets[0].data = requestData;
            requestErrorChart.data.datasets[1].data = errorData;
            requestErrorChart.update();
        }

        // Update latency heatmap with real data
        function updateLatencyHeatmap(dataPoints) {
            const matrixData = [];

            // Create latency buckets (0-9 representing different ranges)
            const latencyBuckets = [
                { min: 0, max: 100, label: '< 100ms' },
                { min: 100, max: 500, label: '100-500ms' },
                { min: 500, max: 1000, label: '500-1000ms' },
                { min: 1000, max: 2000, label: '1000-2000ms' },
                { min: 2000, max: 5000, label: '2000-5000ms' },
                { min: 5000, max: 10000, label: '5000-10000ms' },
                { min: 10000, max: 30000, label: '10000-30000ms' },
                { min: 30000, max: 60000, label: '30000-60000ms' },
                { min: 60000, max: 300000, label: '60000-300000ms' },
                { min: 300000, max: Infinity, label: '> 300000ms' }
            ];

            // Process each data point
            dataPoints.forEach((point, hourIndex) => {
                const timestamp = new Date(point.timestamp);
                const baseLatency = point.latency.value;

                // Create distribution data for each latency bucket
                latencyBuckets.forEach((bucket, bucketIndex) => {
                    // Simulate request count based on latency distribution
                    // In a real implementation, this would come from actual histogram data
                    let requestCount = 0;

                    if (bucketIndex === 0) {
                        // Most requests are fast
                        requestCount = Math.floor(baseLatency < 100 ? 100 + Math.random() * 50 : 20 + Math.random() * 30);
                    } else if (bucketIndex === 1) {
                        // Some requests are medium
                        requestCount = Math.floor(baseLatency < 500 ? 50 + Math.random() * 30 : 10 + Math.random() * 20);
                    } else if (bucketIndex === 2) {
                        // Fewer requests are slow
                        requestCount = Math.floor(baseLatency < 1000 ? 20 + Math.random() * 15 : 5 + Math.random() * 10);
                    } else {
                        // Very few requests are very slow
                        requestCount = Math.floor(Math.random() * 5);
                    }

                    if (requestCount > 0) {
                        matrixData.push({
                            x: timestamp.getTime(),
                            y: bucketIndex,
                            v: requestCount
                        });
                    }
                });
            });

            // Update the chart data
            latencyHeatmap.data.datasets[0].data = matrixData;
            latencyHeatmap.update();
        }

        // Initialize charts
        let requestErrorChart;
        let latencyHeatmap;

        // Initialize dashboard
        async function initializeDashboard() {
            // Initialize charts
            initializeCharts();

            // Initialize SignalR connection
            await initializeSignalR();

            // Fetch initial metrics
            await fetchMetrics();

            // Fetch historical data for charts
            await fetchHistoricalData();

            // Set up periodic refresh as fallback
            setInterval(fetchMetrics, 30000); // Refresh every 30 seconds
        }

        // Initialize Chart.js charts
        function initializeCharts() {
            // Request Rate & Error Rate Chart
            const requestErrorCtx = document.getElementById('requestErrorChart').getContext('2d');
            requestErrorChart = new Chart(requestErrorCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Request Rate (req/s)',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Error Rate (%)',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: false // Hide legend since we have custom one below
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `Request Rate: ${context.parsed.y} req/s`;
                                    } else {
                                        return `Error Rate: ${context.parsed.y}%`;
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Request Rate (req/s)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Error Rate (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            // Response Latency Distribution Heatmap
            const latencyHeatmapCtx = document.getElementById('latencyHeatmap').getContext('2d');
            latencyHeatmap = new Chart(latencyHeatmapCtx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: 'Response Latency (ms)',
                        data: [],
                        backgroundColor: function(context) {
                            const value = context.parsed.v;
                            if (value < 100) return 'rgba(34, 197, 94, 0.8)'; // Green for fast
                            if (value < 500) return 'rgba(251, 191, 36, 0.8)'; // Yellow for medium
                            if (value < 1000) return 'rgba(239, 68, 68, 0.8)'; // Red for slow
                            return 'rgba(147, 51, 234, 0.8)'; // Purple for very slow
                        },
                        borderWidth: 1,
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        width: function(context) {
                            return (context.chart.width / 24) - 2; // 24 hours
                        },
                        height: function(context) {
                            return (context.chart.height / 10) - 2; // 10 latency buckets
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const data = context[0].raw;
                                    return `Time: ${data.x}, Latency Range: ${data.y}ms`;
                                },
                                label: function(context) {
                                    const data = context.raw;
                                    return `Requests: ${data.v}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time (24h)'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Latency (ms)'
                            },
                            ticks: {
                                callback: function(value) {
                                    if (value === 0) return '< 100ms';
                                    if (value === 1) return '100-500ms';
                                    if (value === 2) return '500-1000ms';
                                    if (value === 3) return '1000-2000ms';
                                    if (value === 4) return '2000-5000ms';
                                    if (value === 5) return '5000-10000ms';
                                    if (value === 6) return '10000-30000ms';
                                    if (value === 7) return '30000-60000ms';
                                    if (value === 8) return '60000-300000ms';
                                    return '> 300000ms';
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // Start the dashboard when page loads
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>